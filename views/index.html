<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>BDO</title>
    <script src="assets/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <template id="code-desc-row-template">
      <tr>
        <td class="code"></td>
        <td class="description"></td>
        <td class="action"><button class="button is-small is-rounded">-></button></td>
      </tr>
    </template>
    <template id="code-desc-header-row-template">
      <tr class="selected-waste-header is-selected">
        <th class="code"></th>
        <th class="description"></th>
      </tr>
    </template>

    <template id="installation-capability-template">
      <div class="control">
        <div class="tags has-addons capability">
          <span class="tag waste-code"></span>
          <span class="tag process-code"></span>
          <span class="tag quantity"></span>
        </div>
      </div>
    </template>

    <template id="installation-template">
      <div class="column">
        <div class="panel installation">
          <header class="panel-heading">
            <p class="header name"></p>
            <p class="tag address"></p>
          </header>
          <section class="panel-block">
            <div class="field is-grouped is-grouped-multiline capabilities">
            </div>
          </section>
        </div>
      </div>
    </template>

    <div class="modal processes">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">
            Wyszukaj proces przetwarzania
          </p>
          <button class="cancel button modal-close is-large" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="table-container">
            <table class="table is-narrow is-striped">
              <thead>
                <tr>
                  <th>Kod</th>
                  <th>Opis</th>
                </tr>
              </thead>
              <tbody class="process-list">
              </tbody>
            </table>
          </div>
        </section>
        <footer class="modal-card-foot">
          <div class="cancel button is-link is-fullwidth">
            Anuluj
          </div>
        </footer>
      </div>
    </div>

    <div class="modal wastes">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">
            Wyszukaj kod odpadu
          </p>
          <button class="cancel button modal-close is-large" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="table-container">
            <table class="table is-narrow is-striped">
              <thead class="waste-list-header">
                <tr>
                  <th>Kod</th>
                  <th>Opis</th>
                </tr>
              </thead>
              <tbody class="waste-list">
              </tbody>
            </table>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="cancel button is-link is-fullwidth">Anuluj</button>
        </div>
      </div>
    </div>

    <nav class="navbar">
      <div class="navbar-brand">
        <a class="navbar-item" href="/"><h1>BDO</h1></a>
      </div>
    </nav>

    <section class="section">
      <div class="columns">
        <div class="column" >
          <div class="search panel" id="search">
            <div class="panel-heading">
              <p>Szukaj instalacji</p>
            </div>
            <div class="panel-block">
              <form>
                <div class="field">
                  <label class="label">Kod odpadu</label>
                  <div class="control">
                    <input type="text" name="waste" placeholder="xxxxxx">
                    <button class="button is-small is-link search waste">Wybierz</button>
                  </div>
                  <div class="tag is-primary is-light is-rounded waste-hint code-a"></div>
                  <div class="tag is-primary is-light is-rounded waste-hint code-b"></div>
                  <div class="tag is-primary is-light is-rounded waste-hint code-c"></div>
                </div>
                <div class="field">
                  <label class="label">Proces przetwarzania</label>
                  <div class="control">
                    <input type="text" name="process" placeholder="Rx/Dx">
                    <button class="button is-small is-link search process">Wybierz</button>
                  </div>
                  <div class="tag is-primary is-light is-rounded process-hint"></div>
                </div>
                <div class="field">
                  <label class="label">Województwo</label>
                  <div class="control">
                    <select class="select" name="state">
                      <option value=""></option>
                      <option value="02">dolnośląskie</option>
                      <option value="04">kujawsko-pomorskie</option>
                      <option value="06">lubelskie</option>
                      <option value="08">lubuskie</option>
                      <option value="10">łódzkie</option>
                      <option value="12">małopolskie</option>
                      <option value="14">mazowieckie</option>
                      <option value="16">opolskie</option>
                      <option value="18">podkarpackie</option>
                      <option value="20">podlaskie</option>
                      <option value="22">pomorskie</option>
                      <option value="24">śląskie</option>
                      <option value="26">świętokrzyskie</option>
                      <option value="28">warmińsko-mazurskie</option>
                      <option value="30">wielkopolskie</option>
                      <option value="32">zachodniopomorskie</option>
                    </select>
                    <!--<i class="inverted circular location arrow link icon"></i>-->
                  </div>
                </div>
                <button class="button is-link" type="submit">Szukaj</button>
                <button class="button is-link is-light" type="reset">Wyczyść</button>
              </form>
            </div>
          </div>

        </div>

        <div class="column">
          <div class="card">
            <div class="card-content">
              <div class="image is-5by4" id="map"></div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section class="section">
      <div class="container">
        <div class="columns" id="installations">
        </div>
      </div>
    </section>
  </body>

  <script type="module">
    import {ProcessSelectorView, WasteSelectorView, InstallationRequest, updateUrlSearchParams} from "./js/app.js?q=3"
    import {MapComponent} from "./js/map_component.js"
    import {SearchComponent} from "./js/search_component.js"
    import {InstallationsComponent} from "./js/installations_component.js"

    document.addEventListener("DOMContentLoaded", () => {
      let installationsComponent
      let searchComponent
      let mapComponent = new MapComponent({{.GoogleMapsApiKey}})

      mapComponent.initMap("map").then(()=> {
        installationsComponent = new InstallationsComponent('installations')
        searchComponent = new SearchComponent('search',
          () => {
            installationsComponent.clear()
            mapComponent.clear()
          },
          (params) => {
            updateUrlSearchParams(params)

            installationsComponent.clear()
            mapComponent.clear()

            new InstallationRequest().search(params)
              .then((installations) => {
                installations.forEach((installation, i) => {
                  installationsComponent.addInstallation(installation)
                  mapComponent.addInstallation(installation)
                })
              })
          }
        )

        document.querySelector('.search.process').addEventListener('click', (event) => {
          event.preventDefault();
          let processSelectorView = new ProcessSelectorView
          processSelectorView.load((code, desc) => {
            searchComponent.setProcess(code, desc)
            processSelectorView.hide()
          })
          processSelectorView.show()
        })

        document.querySelector('.search.waste').addEventListener('click', (event) => {
          event.preventDefault();
          var wasteListView = new WasteSelectorView
          wasteListView.load((code, desc) => {
            wasteListView.select(code, desc)
            wasteListView.load((code, desc) => {
              wasteListView.select(code, desc)
              wasteListView.load((code, desc) => {
                searchComponent.setWaste(wasteListView.selectedCode, ...wasteListView.selectedDescs)
                wasteListView.hide()
              })
            })
          })
          wasteListView.show()
        })
      })

    })
  </script>
</html>
